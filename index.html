<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetentionBot: Strategy Helper</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-indigo': '#4f46e5',
                        'primary-dark-indigo': '#4338ca',
                    },
                }
            }
        }
    </script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
        }
        body {
            font-family: 'Inter', sans-serif;
            /* Default Light Mode Background */
            background-color: #f8f9fb; 
        }
        /* Dark mode background defined by JS adding the 'dark' class */
        body.dark {
            background-color: #111827; /* Tailwind gray-900 */
        }
        .email-display {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<!-- Added transition-colors for smooth mode change -->
<body class="min-h-screen p-4 sm:p-8 transition-colors duration-300"> 

    <div class="max-w-4xl mx-auto">
        <!-- Added 'relative' to position the toggle button -->
        <header class="text-center mb-8 relative">
            <!-- Dark Mode Toggle Button -->
            <button onclick="toggleTheme()" class="absolute right-0 top-0 p-2 text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition duration-150 rounded-full">
                <i id="theme-icon" data-lucide="moon" class="w-6 h-6"></i>
            </button>
            
            <div class="flex items-center justify-center space-x-2 text-indigo-600">
                <i data-lucide="shield-check" class="w-8 h-8"></i>
                <!-- Added dark mode text color for heading -->
                <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white">RetentionBot AI</h1>
            </div>
            <!-- Added dark mode text color for subtitle -->
            <p class="text-gray-500 mt-2 dark:text-gray-300">Generate tailored customer save strategies instantly.</p>
        </header>

        <!-- Main Input and Control Area -->
        <!-- Added dark mode background and border for input section -->
        <div id="input-section" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-indigo-100/50 dark:border-indigo-800/50 transition-colors duration-300">
            <!-- NEW: Cancellation Type Selector -->
            <div class="space-y-4 mb-6">
                <div>
                    <label for="cancellationType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cancellation Type</label>
                    <select id="cancellationType" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="Membership">Membership Cancellation (Subscription/App Access)</option>
                        <option value="Order/Return">Order or Return Request (Studio/Move Hardware)</option>
                    </select>
                </div>
            </div>
            
            <!-- Added dark mode text color and border color -->
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white border-b pb-2 dark:border-indigo-700">Customer Context</h2>
            
            <div class="space-y-4 mb-6">
                <!-- Cancellation Reason -->
                <div>
                    <!-- Added dark mode text color for label -->
                    <label for="cancellationReason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer's Reason for Cancelling</label>
                    <!-- Added dark mode styling for textarea -->
                    <textarea id="cancellationReason" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="e.g., 'Price too high, competitor X is cheaper,' or 'Doesn't use Feature Y enough.'"></textarea>
                </div>

                <!-- Customer History -->
                <div>
                    <!-- Added dark mode text color for label -->
                    <label for="customerHistory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer Tenure and History</label>
                    <!-- Added dark mode styling for textarea -->
                    <textarea id="customerHistory" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="e.g., '5 years, high LTV, 0 support tickets,' or '2 months, low usage, 5 recent billing complaints.'"></textarea>
                </div>
                
                <!-- Strategy Focus -->
                <div>
                    <!-- Added dark mode text color for label -->
                    <label for="strategyFocus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Desired Strategy Focus</label>
                    <!-- Added dark mode styling for select -->
                    <select id="strategyFocus" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="Value-Focused">Value-Focused (Focus on hidden benefits/ROI)</option>
                        <option value="Discount-Focused">Discount-Focused (Prioritize price reduction offers)</option>
                        <option value="Product-Focused">Product-Focused (Solve a feature/usability issue)</option>
                        <option value="Motivation/Minimum Discount">Motivation/Minimum Discount (Re-engage with product, minor concession)</option>
                        <option value="Inspirational/Product Value/Tailored Discount">Inspirational/Product Value/Tailored Discount (Aspirational fitness goal + targeted offer)</option>
                        <option value="Empathetic/Motivational/Product Value">Empathetic/Motivational/Product Value (High empathy, low financial offer, strong re-pitch)</option>
                        <option value="Motivational/Fitness Expert/Tailored Features">Motivational/Fitness Expert/Tailored Features (High product knowledge, feature focus, fitness-first approach)</option>
                        <option value="Pause-Retention">Pause/Retention (Temporary solution to save relationship)</option>
                    </select>
                </div>
            </div>

            <button onclick="generateStrategy()" id="generateButton" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center disabled:bg-indigo-400">
                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                Generate Save Strategies
            </button>
            
            <div id="loadingIndicator" class="hidden mt-4 text-center text-indigo-600 font-medium">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-4 border-indigo-500 border-t-transparent mr-2"></div>
                Analyzing data and generating personalized scripts...
            </div>
            
            <p id="errorMessage" class="hidden mt-4 text-center text-red-600 font-medium"></p>
        </div>

        <!-- Output Area for Strategies (Step 1) -->
        <div id="output-section" class="mt-8">
            <!-- Strategies will be inserted here -->
        </div>

        <!-- Email Crafter Section (Step 2) -->
        <div id="email-crafter-section" class="hidden mt-8 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-green-100/50 dark:border-green-800/50 transition-colors duration-300">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 border-b-2 border-green-400 pb-2 flex items-center">
                <i data-lucide="mail-check" class="w-6 h-6 mr-2 text-green-600"></i>
                Expert Winback Email Draft
            </h2>
            <div id="email-loading-indicator" class="hidden text-center text-green-600 font-medium my-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-4 border-green-500 border-t-transparent mr-2"></div>
                Crafting personalized copy...
            </div>
            <div id="email-output" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-800 dark:text-white email-display">
                <!-- Drafted email will go here -->
            </div>
            <button onclick="copyEmailToClipboard()" id="copyEmailButton" class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md flex items-center justify-center">
                <i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>
                Copy Email to Clipboard
            </button>
        </div>

    </div>

    <script>
        const API_KEY = "AIzaSyDHGPN_VAJI6f_Ehld1QW_dNbIUpRf33lM"; // API key inserted here
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        const maxRetries = 3;

        // --- JSON Schema for Structured Output ---
        const retentionSchema = {
            type: "ARRAY",
            description: "A list of 3 distinct customer retention strategies.",
            items: {
                type: "OBJECT",
                properties: {
                    "strategyName": { "type": "STRING", "description": "A concise, actionable title for the strategy (e.g., 'The Value Re-Pitch')." },
                    "coreOffer": { "type": "STRING", "description": "The specific proposal to save the customer (e.g., '30% off for 3 months')." },
                    "talkingPoints": {
                        "type": "ARRAY",
                        "description": "3-5 scripted bullet points focusing on value and empathy for the agent to use, and incorporating relevant product recommendations or next steps.",
                        "items": { "type": "STRING" }
                    },
                    "likelyRebuttal": { "type": "STRING", "description": "Anticipate a likely counter-argument from the customer." },
                    "rebuttalResponse": { "type": "STRING", "description": "A prepared response to handle the rebuttal." },
                    "complianceNote": { "type": "STRING", "description": "A quick note confirming the offer is within the bounds of the compensation guidelines."}
                },
                required: ["strategyName", "coreOffer", "talkingPoints", "likelyRebuttal", "rebuttalResponse", "complianceNote"],
                propertyOrdering: ["strategyName", "coreOffer", "talkingPoints", "likelyRebuttal", "rebuttalResponse", "complianceNote"]
            }
        };

        // Global variables to store context between steps
        let currentCancellationReason = '';
        let currentCustomerHistory = '';
        let currentCancellationType = '';
        let currentStrategyFocus = '';

        // --- Theme Management ---
        const THEME_KEY = 'retentionBotTheme';

        function initTheme() {
            let theme = localStorage.getItem(THEME_KEY);
            if (!theme) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'dark') {
                body.classList.add('dark');
                localStorage.setItem(THEME_KEY, 'dark');
            } else {
                body.classList.remove('dark');
                localStorage.setItem(THEME_KEY, 'light');
            }
            updateThemeIcon(theme);
            lucide.createIcons();
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        function updateThemeIcon(theme) {
            const iconElement = document.getElementById('theme-icon');
            if (iconElement) {
                if (iconElement.querySelector('svg')) {
                    iconElement.innerHTML = '';
                }
                iconElement.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            }
        }


        // --- Core Functions ---

        /**
         * Sets the state of the UI elements (loading, button, error).
         * @param {boolean} isLoading - Whether the application is currently loading.
         * @param {string|null} error - The error message to display, if any.
         * @param {string} mode - 'strategy' or 'email' to control which loading/error indicator is used.
         */
        function setUIState(isLoading, error = null, mode = 'strategy') {
            const button = document.getElementById('generateButton');
            const loading = document.getElementById(mode === 'strategy' ? 'loadingIndicator' : 'email-loading-indicator');
            const errorMsg = document.getElementById('errorMessage');

            if (mode === 'strategy') {
                button.disabled = isLoading;
                button.classList.toggle('opacity-50', isLoading);
                document.getElementById('email-crafter-section').classList.add('hidden'); // Hide email on new strategy search
            }
            
            loading.classList.toggle('hidden', !isLoading);
            
            if (mode === 'strategy') {
                errorMsg.classList.add('hidden');
                if (error) {
                    errorMsg.textContent = error;
                    errorMsg.classList.remove('hidden');
                }
            } else {
                 // For email errors, display a simple message in the output box
                 if (error) {
                    document.getElementById('email-output').textContent = `Error drafting email: ${error}`;
                    document.getElementById('copyEmailButton').classList.add('hidden');
                 }
            }
        }

        /**
         * Calls the Gemini API with exponential backoff for retries.
         * @param {object} payload - The API request body.
         * @param {string} mode - 'strategy' or 'email' to control error messaging.
         * @returns {Promise<any>} - The parsed JSON array or raw text response.
         */
        async function fetchAIContent(payload, mode = 'strategy') {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(`API Request failed: ${errorData.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const content = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!content) {
                         throw new Error("Received an empty or malformed response from the AI model.");
                    }
                    
                    if (mode === 'strategy') {
                        return JSON.parse(content);
                    } else {
                        return content; // Return raw text for email
                    }

                } catch (e) {
                    console.error(`Attempt ${i + 1} failed:`, e);
                    if (i === maxRetries - 1) {
                        throw new Error(e.message);
                    }
                }
            }
        }

        /**
         * Handles the main logic for generating the retention strategy (Step 1).
         */
        async function generateStrategy() {
            setUIState(true, null, 'strategy');
            document.getElementById('output-section').innerHTML = '';

            // Store context globally
            currentCancellationReason = document.getElementById('cancellationReason').value.trim();
            currentCustomerHistory = document.getElementById('customerHistory').value.trim();
            currentStrategyFocus = document.getElementById('strategyFocus').value;
            currentCancellationType = document.getElementById('cancellationType').value;

            if (!currentCancellationReason || !currentCustomerHistory) {
                setUIState(false, "Please fill in both the reason for cancellation and customer history.", 'strategy');
                return;
            }

            if (API_KEY === "") {
                setUIState(false, "API Configuration Error: The AI service failed to authenticate.", 'strategy');
                return;
            }

            // --- ALL ATTACHED DATA AS KNOWLEDGE BASE (MERGED with WinBack Tool Kit) ---
            const concessionData = `
                --- COMPLIANCE & COMPENSATION RULES (HARD LIMITS & WISDOM) ---
                
                // --- MEMBERSHIP CANCELLATION RULES (SUBSCRIPTION) ---
                - Financial/Affordability (Membership): Initial offer should be **low-tier** (1 Month free OR 25% for 4 months). Maximum offer is 50% for 3 months OR 25% for 6 months. **DO NOT EXCEED MAXIMUM.** Offer concessions as options, not bundled.
                - Pause Policy: Standard **3 months max per calendar year**. Extensions possible for severe reasons (e.g., pregnancy, medical injury, severe travel) based on case severity.
                - Lack of motivation/Suitable classes (Membership): Offer **accessory < $30** OR 1 Month free. Recommend accessory giveaway for unmotivated customers.
                - BYOD/Tempo Trainer: Follow above Membership rules. Tempo Trainer members may receive a Giftbox.

                // --- ORDER / RETURN CANCELLATION RULES (HARDWARE/STUDIO/MOVE) ---
                - Financial (Studio/Hardware): Up to 2 months subscription credit OR discount + Giftbox ($100+ after approval). Can offer 50% discount for 4 months max or pause.
                - Delivery delays (Studio): 2 weeks past ETA: 1 Month free. 4 weeks past ETA: 2 Months free (accessories giveaway after approval only).
                - Delivery delays/other return reasons (Move): Up to 1 month subscription credit + accessory < $30.
                - Returning for Wrong color unit (Studio): $100 up to $300 refund OR subscription discount up to 3 months.

                --- WINBACK TOOLKIT FRAMEWORK (PERSONALIZATION FOR MEMBERSHIP) ---
                
                // Winback Patterns for Injury/Dormancy (Membership Focus):
                - Pattern A ("Active before injury"): Focus on strength built. Offer recovery tools (phone-only, 10-15m classes, injury mods). Use offer: Tempo Bands set + 25% off for 4 months.
                - Pattern B ("Long-time member but dormant"): Focus on no-judgment, easy restart. Highlight 10-15 min sessions. Use Offer: Tempo Bands set + 25% off for 4 months.
                - Pattern C ("New member - barely used, injured"): Focus on bad timing. Highlight short, safe ways to try. Use offer: 1 free month or 50% off for 2 months + yoga starter kit.
                - Pattern D ("Started strong then lost motivation"): Focus on nostalgia, reclaiming spark. Highlight low-impact flows, micro-sessions. Use offer: yoga kit + 25% off for 3 months.

                --- CONTENT & ACCESSORIES (FOR RECOMMENDATIONS) ---

                - Accessories (Must cost < $30): Workout Mat ($30), Resistance Bands Set ($21.95), Wrist Heart Rate Monitor ($39 - DO NOT OFFER THIS, only below $30), Yoga Starter Kit (Strap, Block, Roller - Ensure final item value is kept under $30).
                - Recovery & Low-Impact Programs: Improved Mobility, Stretch/Meditate/Recover, Beginnerâ€™s Yoga, Phone-Only Mode, 10-Min Meditation, Low-impact search filter.
                - Strength & Habit Programs: Foundations of Growth, Complete Core, Metabolic Meltdown, 2 Weeks to a Healthier Me.

                --- POLICY REFERENCE ---
                - Policies are governed by: Cancellations & Returns, Tempo Move FAQs, Tempo Experience FAQs, Product Specs.
            `;


            // --- NEW ENHANCED SYSTEM PROMPT (FORCES 3-PHASE EXPERT STRATEGY GENERATION) ---
            const systemPrompt = `You are a **highly experienced, innovative Customer Retention and Marketing Strategist** at a premium fitness company (Tempo). Your core duty is to generate **exceptionally unique and highly personalized** strategies.

            **KNOWLEDGE BASE:**
            ${concessionData}

            **Internal 3-Phase Strategy Generation Process:**
            1. **PHASE 1 (Generate Draft):** Create 3 initial draft strategies using the provided data, ensuring compliance with HARD LIMITS.
            2. **PHASE 2 (Expert Review & Refinement):** Critique the 3 drafts internally based on the following high-level principles:
                - **Creative Product Leverage:** Does the strategy utilize a hidden or under-appreciated product feature (like Phone-Only Mode, specific collections, or injury mods) in a **fresh and compelling way** that directly counters the customer's reason?
                - **Tempo Value Alignment:** Do the talking points align with a brand ethos of **non-judgment, inspiration, long-term health, and celebrating small wins**? Avoid simple policy recitation.
                - **Marketing Hook:** Is the primary pitch strong, memorable, and framed around an **aspirational outcome** rather than just a discount?
            3. **PHASE 3 (Final Output):** Take the refined strategies and output them concisely into the final JSON array.

            **Retention Rules & Guidelines for Final Output:**
            1. **Conciseness is Critical:** Generate all text fields (strategyName, coreOffer, talkingPoints, rebuttalResponse, complianceNote) **as concisely as possible** to ensure the entire JSON response fits within the character limits.
            2. **Concession Wisdom:** **DO NOT** offer the maximum compliant discount as a first approach unless the customer's history/reason warrants aggressive intervention. Accessories (costing < $30) should be prioritized for unmotivated customers. Offers should be presented as clear options, not bundles, unless a specific WinBack Pattern suggests it.
            3. **Strategy Type Differentiation:**
               - If **Cancellation Type is 'Membership'**: Focus on re-engagement (Fitness First), supported by a compliant concession.
               - If **Cancellation Type is 'Order/Return'**: Focus on de-escalation, solving hardware/logistics issue, and offering compliant credits/refunds/gifts.
            4. **Compliance is Mandatory:** The 'coreOffer' and 'complianceNote' fields **MUST** strictly adhere to the compensation rules (HARD LIMITS).
            5. The final output must be a valid JSON array matching the provided schema, with no surrounding text or markdown.
            `;
            
            const userQuery = `Customer Cancellation Reason: ${currentCancellationReason}.
            Customer Tenure/History: ${currentCustomerHistory}.
            Cancellation Type: ${currentCancellationType}.
            
            Generate 3 retention strategies focusing on the ${currentStrategyFocus} approach, ensuring the final output reflects the highest standards of marketing creativity and brand values defined in the system prompt.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: retentionSchema
                }
            };

            try {
                const strategies = await fetchAIContent(payload, 'strategy');
                displayStrategies(strategies);
            } catch (e) {
                setUIState(false, e.message, 'strategy');
            } finally {
                setUIState(false, null, 'strategy');
            }
        }

        /**
         * Renders the generated strategies into the output area.
         * @param {Array<object>} strategies - The array of structured retention strategies.
         */
        function displayStrategies(strategies) {
            const outputDiv = document.getElementById('output-section');
            outputDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 border-b-2 border-indigo-200 dark:border-indigo-700 pb-2 transition-colors duration-300">Generated Retention Plan</h2>
            `;

            if (!Array.isArray(strategies) || strategies.length === 0) {
                 outputDiv.innerHTML += '<p class="text-red-500">Could not parse the strategies. Please try a different prompt or check the console for API errors.</p>';
                 return;
            }


            strategies.forEach((strategy, index) => {
                const strategyElement = document.createElement('div');
                strategyElement.classList.add('bg-white', 'dark:bg-gray-800', 'p-6', 'rounded-xl', 'shadow-xl', 'mb-8', 'border-l-4', 'border-indigo-500', 'transition-colors', 'duration-300');

                const titleColor = ['bg-indigo-50', 'bg-blue-50', 'bg-green-50'][index % 3];
                const iconName = ['trending-up', 'check-circle', 'refresh-cw'][index % 3];
                
                // Safely convert the object to a JSON string for passing to the craftEmail function
                const strategyJsonString = JSON.stringify(strategy).replace(/"/g, '&quot;');


                strategyElement.innerHTML = `
                    <div class="flex items-center space-x-3 mb-4 p-3 rounded-lg ${titleColor}">
                        <i data-lucide="${iconName}" class="w-6 h-6 text-indigo-600"></i>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">${strategy.strategyName}</h3>
                    </div>

                    <div class="space-y-6">
                        <!-- Core Offer -->
                        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                            <p class="text-sm font-semibold text-indigo-700">CORE SAVE OFFER:</p>
                            <p class="text-lg font-medium text-gray-800 dark:text-white mt-1">${strategy.coreOffer}</p>
                            <p class="text-xs text-indigo-500 mt-2 font-medium">Compliance Note: ${strategy.complianceNote}</p>
                        </div>

                        <!-- Talking Points -->
                        <div>
                            <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-2 flex items-center">
                                <i data-lucide="message-square" class="w-4 h-4 mr-2 text-gray-500"></i>
                                Agent Talking Points (Fitness & Value Focus)
                            </p>
                            <ul class="list-none space-y-2 text-gray-700 dark:text-white">
                                ${strategy.talkingPoints.map(point => 
                                    `<li class="flex items-start">
                                        <i data-lucide="chevron-right" class="w-4 h-4 mt-1 mr-2 text-indigo-400 flex-shrink-0"></i>
                                        <span>${point}</span>
                                    </li>`).join('')}
                            </ul>
                        </div>

                        <!-- Rebuttal Handling -->
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm font-semibold text-yellow-700 mb-1 flex items-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mr-2 text-yellow-600"></i>
                                LIKELY CUSTOMER REBUTTAL
                            </p>
                            <p class="text-gray-700 italic dark:text-gray-200">"&quot;${strategy.likelyRebuttal}&quot;"</p>
                            
                            <p class="text-sm font-semibold text-green-700 mt-3 mb-1 flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-2 text-green-600"></i>
                                AGENT RESPONSE
                            </p>
                            <p class="text-gray-800 font-medium dark:text-white">${strategy.rebuttalResponse}</p>
                        </div>
                    </div>
                    
                    <!-- New Button for Step 2 -->
                    <button onclick="craftEmail('${strategyJsonString}')" class="mt-4 w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center">
                        <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                        Draft Winback Email using this Strategy
                    </button>
                `;
                outputDiv.appendChild(strategyElement);
            });
            lucide.createIcons(); 
        }

        /**
         * Handles the email crafting process (Step 2).
         * @param {string} strategyJson - JSON string of the selected strategy.
         */
        async function craftEmail(strategyJson) {
            setUIState(true, null, 'email');
            document.getElementById('email-output').textContent = '';
            document.getElementById('email-crafter-section').classList.remove('hidden');
            document.getElementById('copyEmailButton').classList.remove('hidden'); // Show copy button

            const selectedStrategy = JSON.parse(strategyJson.replace(/&quot;/g, '"'));
            
            // --- EMAIL CRAFTING SYSTEM PROMPT (UPDATED FOR HUMAN-CENTERED COPY) ---
            const emailSystemPrompt = `You are a **Senior Retention Specialist and Human-Centered Copywriter** for a premium fitness brand (Tempo). Your goal is to write a **high-conversion, customer-centric winback email** (200-250 words max) based on the provided strategy.

            **Email Structure Rules:**
            1. **Tone:** The tone must be **natural, human, highly empathetic, and non-judgmental.** Use contractions and conversational language. Focus on the customer's perspective and frame the offer as support for their individual journey.
            2. **Personalization & Context:** Reference the 'Cancellation Reason' and 'Customer Tenure/History' from the context naturally in the opening.
            3. **Preemptive Defense:** Smoothly integrate the core message of the 'likelyRebuttal' and the 'rebuttalResponse' to address their probable counter-argument before they raise it.
            4. **Call to Action:** The final paragraph must clearly present the 'Core Offer' and include a soft, clear Call to Action.
            5. **Subject Line:** Generate a short, highly personalized, and compelling subject line (max 10 words).
            6. **Format:** Output the response as clean, plain text with distinct lines for the Subject and Body, ready to be copied directly into an email client. Do NOT use markdown. Start with the Subject Line, followed by the Body.

            **Context for Email:**
            Cancellation Reason: ${currentCancellationReason}
            Customer History: ${currentCustomerHistory}
            Cancellation Type: ${currentCancellationType}
            
            **Selected Strategy Focus for Tone:** ${currentStrategyFocus} 
            `;

            const emailQuery = `Draft the complete email (Subject Line and Body) using the following strategy JSON:
            ${JSON.stringify(selectedStrategy, null, 2)}`;

            const payload = {
                contents: [{ parts: [{ text: emailQuery }] }],
                systemInstruction: { parts: [{ text: emailSystemPrompt }] },
            };

            try {
                const draftedEmail = await fetchAIContent(payload, 'email');
                displayEmail(draftedEmail);
            } catch (e) {
                setUIState(false, e.message, 'email');
            } finally {
                setUIState(false, null, 'email');
            }
        }

        /**
         * Renders the drafted email and handles the clipboard functionality.
         * @param {string} emailText - The raw text of the drafted email.
         */
        function displayEmail(emailText) {
            const outputDiv = document.getElementById('email-output');
            outputDiv.textContent = emailText;
            document.getElementById('copyEmailButton').dataset.email = emailText;
        }

        /**
         * Copies the email text to the user's clipboard.
         */
        function copyEmailToClipboard() {
            const emailText = document.getElementById('email-output').textContent;
            
            // Use execCommand for broader compatibility in iframe environments
            const textArea = document.createElement("textarea");
            textArea.value = emailText;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'Copied successfully!' : 'Failed to copy.';
                
                // Show temporary success feedback on the button
                const button = document.getElementById('copyEmailButton');
                const originalText = button.innerHTML;
                button.innerHTML = `<i data-lucide="check" class="w-5 h-5 mr-2"></i> ${msg}`;
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    lucide.createIcons();
                }, 1500);

            } catch (err) {
                console.error('Copy command failed:', err);
                // Fallback UI alert/message (without using window.alert)
                document.getElementById('errorMessage').textContent = 'Copy failed. Please manually select and copy the text.';
                document.getElementById('errorMessage').classList.remove('hidden');
            } finally {
                document.body.removeChild(textArea);
                lucide.createIcons();
            }
        }


        // Initialize theme and icons when the content is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); 
            lucide.createIcons();
        });
    </script>
</body>
</html>
