<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetentionBot: Strategy Helper</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-indigo': '#4f46e5',
                        'primary-dark-indigo': '#4338ca',
                    },
                }
            }
        }
    </script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
        }
        body {
            font-family: 'Inter', sans-serif;
            /* Default Light Mode Background */
            background-color: #f8f9fb; 
        }
        /* Dark mode background defined by JS adding the 'dark' class */
        body.dark {
            background-color: #111827; /* Tailwind gray-900 */
        }
    </style>
</head>
<!-- Added transition-colors for smooth mode change -->
<body class="min-h-screen p-4 sm:p-8 transition-colors duration-300"> 

    <div class="max-w-4xl mx-auto">
        <!-- Added 'relative' to position the toggle button -->
        <header class="text-center mb-8 relative">
            <!-- Dark Mode Toggle Button -->
            <button onclick="toggleTheme()" class="absolute right-0 top-0 p-2 text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition duration-150 rounded-full">
                <i id="theme-icon" data-lucide="moon" class="w-6 h-6"></i>
            </button>
            
            <div class="flex items-center justify-center space-x-2 text-indigo-600">
                <i data-lucide="shield-check" class="w-8 h-8"></i>
                <!-- Added dark mode text color for heading -->
                <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white">RetentionBot AI</h1>
            </div>
            <!-- Added dark mode text color for subtitle -->
            <p class="text-gray-500 mt-2 dark:text-gray-300">Generate tailored customer save strategies instantly.</p>
        </header>

        <!-- Main Input and Control Area -->
        <!-- Added dark mode background and border for input section -->
        <div id="input-section" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-indigo-100/50 dark:border-indigo-800/50 transition-colors duration-300">
            <!-- NEW: Cancellation Type Selector -->
            <div class="space-y-4 mb-6">
                <div>
                    <label for="cancellationType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cancellation Type</label>
                    <select id="cancellationType" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="Membership">Membership Cancellation (Subscription/App Access)</option>
                        <option value="Order/Return">Order or Return Request (Studio/Move Hardware)</option>
                    </select>
                </div>
            </div>
            
            <!-- Added dark mode text color and border color -->
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white border-b pb-2 dark:border-indigo-700">Customer Context</h2>
            
            <div class="space-y-4 mb-6">
                <!-- Cancellation Reason -->
                <div>
                    <!-- Added dark mode text color for label -->
                    <label for="cancellationReason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer's Reason for Cancelling</label>
                    <!-- Added dark mode styling for textarea -->
                    <textarea id="cancellationReason" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="e.g., 'Price too high, competitor X is cheaper,' or 'Doesn't use Feature Y enough.'"></textarea>
                </div>

                <!-- Customer History -->
                <div>
                    <!-- Added dark mode text color for label -->
                    <label for="customerHistory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer Tenure and History</label>
                    <!-- Added dark mode styling for textarea -->
                    <textarea id="customerHistory" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="e.g., '5 years, high LTV, 0 support tickets,' or '2 months, low usage, 5 recent billing complaints.'"></textarea>
                </div>
                
                <!-- Strategy Focus -->
                <div>
                    <!-- Added dark mode text color for label -->
                    <label for="strategyFocus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Desired Strategy Focus</label>
                    <!-- Added dark mode styling for select -->
                    <select id="strategyFocus" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-gray-800 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="Value-Focused">Value-Focused (Focus on hidden benefits/ROI)</option>
                        <option value="Discount-Focused">Discount-Focused (Prioritize price reduction offers)</option>
                        <option value="Product-Focused">Product-Focused (Solve a feature/usability issue)</option>
                        <option value="Motivation/Minimum Discount">Motivation/Minimum Discount (Re-engage with product, minor concession)</option>
                        <option value="Inspirational/Product Value/Tailored Discount">Inspirational/Product Value/Tailored Discount (Aspirational fitness goal + targeted offer)</option>
                        <option value="Pause-Retention">Pause/Retention (Temporary solution to save relationship)</option>
                    </select>
                </div>
            </div>

            <button onclick="generateStrategy()" id="generateButton" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center disabled:bg-indigo-400">
                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                Generate Save Strategies
            </button>
            
            <div id="loadingIndicator" class="hidden mt-4 text-center text-indigo-600 font-medium">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-4 border-indigo-500 border-t-transparent mr-2"></div>
                Analyzing data and generating personalized scripts...
            </div>
            
            <p id="errorMessage" class="hidden mt-4 text-center text-red-600 font-medium"></p>
        </div>

        <!-- Output Area for Strategies -->
        <div id="output-section" class="mt-8">
            <!-- Strategies will be inserted here -->
        </div>

    </div>

    <script>
        const API_KEY = "AIzaSyDHGPN_VAJI6f_Ehld1QW_dNbIUpRf33lM"; // API key inserted here
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        const maxRetries = 3;

        // --- JSON Schema for Structured Output ---
        const retentionSchema = {
            type: "ARRAY",
            description: "A list of 3 distinct customer retention strategies.",
            items: {
                type: "OBJECT",
                properties: {
                    "strategyName": { "type": "STRING", "description": "A concise, actionable title for the strategy (e.g., 'The Value Re-Pitch')." },
                    "coreOffer": { "type": "STRING", "description": "The specific proposal to save the customer (e.g., '30% off for 3 months')." },
                    "talkingPoints": {
                        "type": "ARRAY",
                        "description": "3-5 scripted bullet points focusing on value and empathy for the agent to use, and incorporating relevant product recommendations or next steps.",
                        "items": { "type": "STRING" }
                    },
                    "likelyRebuttal": { "type": "STRING", "description": "Anticipate a likely counter-argument from the customer." },
                    "rebuttalResponse": { "type": "STRING", "description": "A prepared response to handle the rebuttal." },
                    "complianceNote": { "type": "STRING", "description": "A quick note confirming the offer is within the bounds of the compensation guidelines."}
                },
                required: ["strategyName", "coreOffer", "talkingPoints", "likelyRebuttal", "rebuttalResponse", "complianceNote"],
                propertyOrdering: ["strategyName", "coreOffer", "talkingPoints", "likelyRebuttal", "rebuttalResponse", "complianceNote"]
            }
        };

        // --- Theme Management ---
        const THEME_KEY = 'retentionBotTheme';

        /**
         * Initializes the theme based on local storage or system preference.
         */
        function initTheme() {
            // 1. Check local storage
            let theme = localStorage.getItem(THEME_KEY);

            // 2. If no preference, check system preference
            if (!theme) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            // 3. Apply the theme
            applyTheme(theme);
        }

        /**
         * Applies the given theme (light or dark) to the body and updates localStorage.
         * @param {string} theme - 'light' or 'dark'.
         */
        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'dark') {
                body.classList.add('dark');
                localStorage.setItem(THEME_KEY, 'dark');
            } else {
                body.classList.remove('dark');
                localStorage.setItem(THEME_KEY, 'light');
            }
            updateThemeIcon(theme);
            // Re-create lucide icons to ensure theme icon is rendered correctly
            lucide.createIcons();
        }

        /**
         * Toggles the current theme and persists the choice.
         */
        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        /**
         * Updates the Lucide icon based on the current theme.
         * @param {string} theme - 'light' or 'dark'.
         */
        function updateThemeIcon(theme) {
            const iconElement = document.getElementById('theme-icon');
            if (iconElement) {
                // Remove all lucide data-lucide attributes first
                if (iconElement.querySelector('svg')) {
                    iconElement.innerHTML = '';
                }
                // Set new icon based on the intended *next* action
                // Show 'sun' icon when currently dark (user can click to switch to light)
                iconElement.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            }
        }


        // --- Core Functions ---

        /**
         * Sets the state of the UI elements (loading, button, error).
         * @param {boolean} isLoading - Whether the application is currently loading.
         * @param {string|null} error - The error message to display, if any.
         */
        function setUIState(isLoading, error = null) {
            const button = document.getElementById('generateButton');
            const loading = document.getElementById('loadingIndicator');
            const errorMsg = document.getElementById('errorMessage');

            button.disabled = isLoading;
            button.classList.toggle('opacity-50', isLoading);
            loading.classList.toggle('hidden', !isLoading);
            errorMsg.classList.add('hidden');
            if (error) {
                errorMsg.textContent = error;
                errorMsg.classList.remove('hidden');
            }
        }

        /**
         * Calls the Gemini API with exponential backoff for retries.
         * @param {object} payload - The API request body.
         * @returns {Promise<Array<object>>} - The parsed JSON array of strategies.
         */
        async function fetchStrategyWithRetry(payload) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            // Too Many Requests, implement exponential backoff
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        const errorData = await response.json();
                        throw new Error(`API Request failed: ${errorData.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!jsonText) {
                         throw new Error("Received an empty or malformed response from the AI model. Check system prompt adherence.");
                    }
                    
                    return JSON.parse(jsonText);

                } catch (e) {
                    // Log the attempt failure but only throw final error after max retries
                    console.error(`Attempt ${i + 1} failed:`, e);
                    if (i === maxRetries - 1) {
                        throw new Error(`Failed to connect to AI after ${maxRetries} attempts. Error: ${e.message}`);
                    }
                }
            }
        }

        /**
         * Handles the main logic for generating the retention strategy.
         */
        async function generateStrategy() {
            setUIState(true);
            document.getElementById('output-section').innerHTML = ''; // Clear previous output

            const reason = document.getElementById('cancellationReason').value.trim();
            const history = document.getElementById('customerHistory').value.trim();
            const focus = document.getElementById('strategyFocus').value;
            const type = document.getElementById('cancellationType').value; // Get the new cancellation type

            if (!reason || !history) {
                setUIState(false, "Please fill in both the reason for cancellation and customer history.");
                return;
            }

            // --- CRITICAL CHECK FOR EXTERNAL HOSTING ---
            if (API_KEY === "") {
                setUIState(false, "API Configuration Error: The AI service failed to authenticate. If running externally, please ensure your Gemini API key is configured.");
                return;
            }

            // --- ALL ATTACHED DATA AS KNOWLEDGE BASE (MERGED with WinBack Tool Kit) ---
            const concessionData = `
                --- COMPLIANCE & COMPENSATION RULES (HARD LIMITS) ---
                
                // --- MEMBERSHIP CANCELLATION RULES (SUBSCRIPTION) ---
                - Financial/Affordability (Membership): up to 1 Month free OR 25% discount for 4 months. MAXIMUM: 50% discount for 3 months OR 25% for 6 months. Suggest Pause Option.
                - Lack of motivation/Suitable classes (Membership): 1 Month free OR accessory < $40 (Workout Mat, Bands, Heart Rate Monitor). Suggest challenges/programs.
                - BYOD/Tempo Trainer: Follow above Membership rules. Tempo Trainer members may receive a Giftbox.

                // --- ORDER / RETURN CANCELLATION RULES (HARDWARE/STUDIO/MOVE) ---
                - Financial (Studio/Hardware): Up to 2 months subscription credit OR discount + Giftbox ($100+ after approval). Can offer 50% discount for 4 months max or pause.
                - Delivery delays (Studio): 2 weeks past ETA: 1 Month free. 4 weeks past ETA: 2 Months free (accessories giveaway after approval only).
                - Delivery delays/other return reasons (Move): Up to 1 month subscription credit + accessory < $50.
                - Returning for Wrong color unit (Studio): $100 up to $300 refund OR subscription discount up to 3 months.

                --- WINBACK TOOLKIT FRAMEWORK (PERSONALIZATION FOR MEMBERSHIP) ---
                
                // Winback Patterns for Injury/Dormancy (Membership Focus):
                - Pattern A ("Active before injury"): Focus on strength built. Offer recovery tools (phone-only, 10-15m classes, injury mods). Use offer: Tempo Bands set + 25% off for 4 months.
                - Pattern B ("Long-time member but dormant"): Focus on no-judgment, easy restart. Highlight 10-15 min sessions. Use Offer: Tempo Bands set + 25% off for 4 months.
                - Pattern C ("New member - barely used, injured"): Focus on bad timing. Highlight short, safe ways to try. Use Offer: 1 free month or 50% off for 2 months + yoga starter kit.
                - Pattern D ("Started strong then lost motivation"): Focus on nostalgia, reclaiming spark. Highlight low-impact flows, micro-sessions. Use Offer: yoga kit + 25% off for 3 months.

                --- CONTENT & ACCESSORIES (FOR RECOMMENDATIONS) ---

                - Accessories: Workout Mat ($30), Resistance Bands Set ($21.95), Wrist Heart Rate Monitor ($39), Yoga Starter Kit (Strap, Block, Roller).
                - Recovery & Low-Impact Programs: Improved Mobility, Stretch/Meditate/Recover, Beginnerâ€™s Yoga, Phone-Only Mode, 10-Min Meditation, Low-impact search filter.
                - Strength & Habit Programs: Foundations of Growth, Complete Core, Metabolic Meltdown, 2 Weeks to a Healthier Me.

                --- POLICY REFERENCE ---
                - Policies are governed by: Cancellations & Returns, Tempo Move FAQs, Tempo Experience FAQs, Product Specs.
            `;


            // --- ENHANCED SYSTEM PROMPT ---
            const systemPrompt = `You are a world-class Customer Retention Specialist and a master of turning cancellations into long-term customer loyalty at a premium fitness company. Your core duty is to create **highly personalized** strategies.
            
            **KNOWLEDGE BASE:**
            ${concessionData}

            **Retention Rules & Guidelines:**
            1. **Conciseness is Critical:** Generate all text fields (strategyName, coreOffer, talkingPoints, rebuttalResponse, complianceNote) **as concisely as possible** to ensure the entire JSON response fits within the character limits. Avoid verbose, multi-sentence descriptions where a short, clear phrase will suffice.
            2. **Personalization & Pattern:** Based on the 'Customer Tenure/History' and 'Cancellation Reason', determine which 'Winback Pattern' or 'Compliance Rule' in the KNOWLEDGE BASE is most relevant. The talking points must be highly tailored, using the customer's specific history/issue (e.g., 'your 700 classes' or 'the delivery delay') to structure the pitch.
            3. **Strategy Type Differentiation:**
               - If **Cancellation Type is 'Membership'**: The strategy must focus on re-engagement using fitness content and programs (Fitness First), supported by a compliant concession (using Winback Patterns).
               - If **Cancellation Type is 'Order/Return'**: The strategy must focus on de-escalation, solving the hardware/logistics issue, and offering compliant credits/refunds/gifts (using Order/Return Compliance Rules).
            4. **Compliance is Mandatory:** The 'coreOffer' and 'complianceNote' fields **MUST** strictly adhere to the compensation rules (HARD LIMITS) based on the *Cancellation Type* and *Reason*.
            5. **Generate exactly 3 diverse strategies.**
            6. The final output must be a valid JSON array matching the provided schema, with no surrounding text or markdown.
            `;
            
            const userQuery = `Customer Cancellation Reason: ${reason}.
            Customer Tenure/History: ${history}.
            Cancellation Type: ${type}.
            
            Generate 3 retention strategies focusing on the ${focus} approach.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: retentionSchema
                }
            };

            try {
                const strategies = await fetchStrategyWithRetry(payload);
                displayStrategies(strategies);
            } catch (e) {
                setUIState(false, e.message);
            } finally {
                setUIState(false);
            }
        }

        /**
         * Renders the generated strategies into the output area, applying dark mode classes dynamically.
         * @param {Array<object>} strategies - The array of structured retention strategies.
         */
        function displayStrategies(strategies) {
            const outputDiv = document.getElementById('output-section');
            // Added dark mode text color for heading
            outputDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 border-b-2 border-indigo-200 dark:border-indigo-700 pb-2 transition-colors duration-300">Generated Retention Plan</h2>
            `;

            if (!Array.isArray(strategies) || strategies.length === 0) {
                 outputDiv.innerHTML += '<p class="text-red-500">Could not parse the strategies. Please try a different prompt or check the console for API errors.</p>';
                 return;
            }


            strategies.forEach((strategy, index) => {
                const strategyElement = document.createElement('div');
                // Added dark mode background and transition
                strategyElement.classList.add('bg-white', 'dark:bg-gray-800', 'p-6', 'rounded-xl', 'shadow-xl', 'mb-8', 'border-l-4', 'border-indigo-500', 'transition-colors', 'duration-300');

                // Dynamic properties for strategy titles
                const titleColor = ['bg-indigo-50', 'bg-blue-50', 'bg-green-50'][index % 3];
                const iconName = ['trending-up', 'check-circle', 'refresh-cw'][index % 3];

                // Note: The template literal uses the strategy object properties to build the card structure.
                strategyElement.innerHTML = `
                    <div class="flex items-center space-x-3 mb-4 p-3 rounded-lg ${titleColor}">
                        <i data-lucide="${iconName}" class="w-6 h-6 text-indigo-600"></i>
                        <!-- Added dark mode text color for strategy title -->
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">${strategy.strategyName}</h3>
                    </div>

                    <div class="space-y-6">
                        <!-- Core Offer -->
                        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                            <p class="text-sm font-semibold text-indigo-700">CORE SAVE OFFER:</p>
                            <p class="text-lg font-medium text-gray-800 dark:text-white mt-1">${strategy.coreOffer}</p>
                            <p class="text-xs text-indigo-500 mt-2 font-medium">Compliance Note: ${strategy.complianceNote}</p>
                        </div>

                        <!-- Talking Points -->
                        <div>
                            <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-2 flex items-center">
                                <i data-lucide="message-square" class="w-4 h-4 mr-2 text-gray-500"></i>
                                Agent Talking Points (Fitness & Value Focus)
                            </p>
                            <!-- Added dark mode text color for talking points list -->
                            <ul class="list-none space-y-2 text-gray-700 dark:text-white">
                                ${strategy.talkingPoints.map(point => 
                                    `<li class="flex items-start">
                                        <i data-lucide="chevron-right" class="w-4 h-4 mt-1 mr-2 text-indigo-400 flex-shrink-0"></i>
                                        <span>${point}</span>
                                    </li>`).join('')}
                            </ul>
                        </div>

                        <!-- Rebuttal Handling -->
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm font-semibold text-yellow-700 mb-1 flex items-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mr-2 text-yellow-600"></i>
                                LIKELY CUSTOMER REBUTTAL
                            </p>
                            <!-- Added dark mode text color for italic rebuttal text -->
                            <p class="text-gray-700 italic dark:text-gray-200">"&quot;${strategy.likelyRebuttal}&quot;"</p>
                            
                            <p class="text-sm font-semibold text-green-700 mt-3 mb-1 flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-2 text-green-600"></i>
                                AGENT RESPONSE
                            </p>
                            <!-- Added dark mode text color for response text -->
                            <p class="text-gray-800 font-medium dark:text-white">${strategy.rebuttalResponse}</p>
                        </div>
                    </div>
                `;
                outputDiv.appendChild(strategyElement);
            });
            // Re-initialize icons so the data-lucide attributes in the generated HTML are rendered.
            lucide.createIcons(); 
        }

        // Initialize theme and icons when the content is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); 
            lucide.createIcons();
        });
    </script>
</body>
</html>
